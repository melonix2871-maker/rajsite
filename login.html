<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Login</title>
</head>
<body>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
  <img alt="Logo" width="36" height="36" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Crect width='36' height='36' rx='8' fill='%230066ff'/%3E%3Ctext x='18' y='23' font-size='16' text-anchor='middle' fill='white' font-family='Arial'%3EJ%3C/text%3E%3C/svg%3E">
  <span style="font-size:18px;font-weight:600">Admin Login</span>
</div>
<h1>Login</h1>
<div id="status" style="margin-bottom:12px"></div>
<form id="login-form" style="margin-top:12px;max-width:360px">
  <input type="hidden" id="csrf-login-token" name="csrf_token">
  <label style="display:block;margin:8px 0">Username <input id="login-username" autocomplete="username"></label>
  <label style="display:block;margin:8px 0">Password <input id="login-password" type="password" autocomplete="current-password"></label>
  <button type="submit">Sign In</button>
</form>
<div style="margin-top:24px">
  <h2>Register</h2>
  <form id="register-form" style="margin-top:12px;max-width:360px">
    <input type="hidden" id="csrf-register-token" name="csrf_token">
    <label style="display:block;margin:8px 0">Username <input id="reg-username" autocomplete="username"></label>
    <label style="display:block;margin:8px 0">Password <input id="reg-password" type="password" autocomplete="new-password"></label>
    <label style="display:block;margin:8px 0">Confirm <input id="reg-confirm" type="password" autocomplete="new-password"></label>
    <button type="submit">Create Account</button>
  </form>
  <div id="register-status" style="margin-top:8px"></div>
</div>
<div style="margin-top:12px"><a href="index.html">Back to Home</a></div>
<script>
const WRITE_CONFIG_URL = 'https://coreenginedb.meoasis2014.workers.dev/json/config.json'
const WRITE_DB_URL = 'https://coreenginedb.meoasis2014.workers.dev/json/db.json'
function getCoreUrls(){ return { configUrl: WRITE_CONFIG_URL, dbUrl: WRITE_DB_URL } }
try{ const app = JSON.parse(sessionStorage.getItem('app_auth')||'null'); if(app && String(app.role||'')==='superadmin'){ window.location.href='admin.html' } else if(app){ window.location.href='index.html' } }catch(_){}
</script>
<script>
async function tryLogin(username, password){
  try{
    const listResp = await fetch('https://assets.antserver1.eu.org/db.json', { cache:'no-store', mode:'cors', credentials:'omit' })
    if(!listResp.ok){ document.getElementById('status').textContent = '❌ Cannot read users'; return }
    const rows = await listResp.json().catch(()=>[])
    if(!Array.isArray(rows)){ document.getElementById('status').textContent = '❌ Invalid db.json'; return }
    const su = rows.find(r => String(r.prefix||'')==='coreenginedb_' && String(r.collection||'')==='superuser' && String(r.metakey||'')===String(username))
    if(su && String(su.metavalue||'')===String(password)){
      sessionStorage.setItem('app_auth', JSON.stringify({ role:'superadmin', username }))
      sessionStorage.setItem('cedb_auth', 'Basic '+ btoa(String(username)+':'+String(password)))
      window.location.href='admin.html'
      return
    }
    const urec = rows.find(r => String(r.prefix||'')==='app_' && String(r.collection||'')==='users' && String(r.metakey||'')==='username' && String(r.metavalue||'')===String(username))
    if(urec){
      const passrec = rows.find(r => String(r.prefix||'')==='app_' && String(r.collection||'')==='users' && String(r.metakey||'')==='password' && Number(r.relid||0)===Number(urec.relid||0))
      if(passrec){
        let ok = false
        try{
          const payload = JSON.parse(String(passrec.metavalue||''))
          if(payload && payload.hash && payload.salt && payload.iterations){
            const calc = await pbkdf2Hex(password, String(payload.salt), Number(payload.iterations||100000), 32)
            ok = (String(calc) === String(payload.hash))
          }
        }catch(_e){ ok = false }
        if(!ok){ ok = (String(passrec.metavalue||'')===String(password)) }
        if(ok){
          sessionStorage.setItem('app_auth', JSON.stringify({ role:'user', username, relid:Number(urec.relid||0) }))
          window.location.href='index.html'
          return
        }
      }
    }
    document.getElementById('status').textContent = '❌ Invalid credentials'
  }catch(e){ document.getElementById('status').textContent = '❌ Login error' }
}
document.getElementById('login-form').addEventListener('submit', (e)=>{
  e.preventDefault()
  const u = document.getElementById('login-username').value.trim()
  const p = document.getElementById('login-password').value.trim()
  if(!u || !p){ document.getElementById('status').textContent = 'Enter username and password'; return }
  tryLogin(u,p)
})
function hex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('') }
function randHex(n){ const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('') }
async function pbkdf2Hex(password, salt, iterations, length){ const enc = new TextEncoder(); const key = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']); const bits = await crypto.subtle.deriveBits({ name:'PBKDF2', hash:'SHA-256', salt: enc.encode(salt), iterations }, key, (length||32)*8); return hex(bits) }
async function readConfig(){ try{ const { configUrl } = getCoreUrls(); const r = await fetch(configUrl, { cache:'no-store', mode:'cors', credentials:'omit' }); if(!r.ok) return {}; const et=r.headers.get('etag'); if(et) window.cedbEtag = et; const t = await r.text(); try{ return JSON.parse(t) }catch(_){ return {} } }catch(_e){ return {} } }
async function writeConfig(cfg){ try{ const { configUrl } = getCoreUrls(); const et=window.cedbEtag||''; const headers=Object.assign({ 'Content-Type':'application/json' }, et? { 'If-Match': et } : {}); const body=JSON.stringify(cfg,null,2); const r = await fetch(configUrl, { method:'PUT', headers, body, mode:'cors', credentials:'omit' }); if(r.status===412){ document.getElementById('register-status').textContent='❌ Conflict — refresh and retry'; return false } if(!r.ok){ document.getElementById('register-status').textContent='❌ Write failed'; return false } const newEt=r.headers.get('etag'); if(newEt) window.cedbEtag = newEt; return true }catch(_e){ document.getElementById('register-status').textContent='❌ Write error'; return false } }
document.getElementById('register-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  let csrf = sessionStorage.getItem('csrf_token');
  if(!csrf){ try{ const a=new Uint8Array(32); crypto.getRandomValues(a); csrf=Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); sessionStorage.setItem('csrf_token', csrf); document.cookie='csrf_token='+csrf+'; SameSite=Strict; Secure; path=/'; }catch(_){ csrf=''; }
  }
  const u = document.getElementById('reg-username').value.trim();
  const p = document.getElementById('reg-password').value.trim();
  const c = document.getElementById('reg-confirm').value.trim();
  if(!u || !p || p!==c){ document.getElementById('register-status').textContent='Enter matching username/password'; return }
  try{
    // read current db via Worker (to keep ETag for write)
    const head = await fetch(WRITE_DB_URL, { method:'HEAD' })
    const et = head.headers.get('etag')||''
    const rows = await (await fetch(WRITE_DB_URL)).json().catch(()=>[])
    if(!Array.isArray(rows)) { document.getElementById('register-status').textContent='❌ Invalid db.json'; return }
    const exists = rows.find(r => String(r.prefix||'')==='app_' && String(r.collection||'')==='users' && String(r.metakey||'')==='username' && String(r.metavalue||'')===u)
    if(exists){ document.getElementById('register-status').textContent='❌ Username already exists'; return }
    const maxRel = rows.reduce((m,r)=> (String(r.prefix||'')==='app_' && String(r.collection||'')==='users' ? Math.max(m, Number(r.relid||0)) : m), 100)
    const relid = Number(maxRel)+1
    const now = new Date().toISOString()
    const salt = randHex(12)
    const iterations = 100000
    const hash = await pbkdf2Hex(p, salt, iterations, 32)
    rows.push({ id: crypto.randomUUID(), relid, prefix:'app_', collection:'users', metakey:'username', metavalue:u, createddate: now, updateddate: now })
    rows.push({ id: crypto.randomUUID(), relid, prefix:'app_', collection:'users', metakey:'password', metavalue: JSON.stringify({ hash, salt, iterations }), createddate: now, updateddate: now })
    const r = await fetch(WRITE_DB_URL, { method:'PUT', headers: Object.assign({ 'Content-Type':'application/json' }, et? { 'If-Match': et } : {}), body: JSON.stringify(rows, null, 2) })
    if(!r.ok){ document.getElementById('register-status').textContent='❌ Registration failed'; return }
    document.getElementById('register-status').textContent='✅ Registered. Sign in now.'
  }catch(_e){ document.getElementById('register-status').textContent='❌ Registration error' }
})
</script>
<script>
;(function(){
  function gen(n){ const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('') }
  let t = sessionStorage.getItem('csrf_token');
  if(!t){ try{ t = gen(32); sessionStorage.setItem('csrf_token', t); document.cookie='csrf_token='+t+'; SameSite=Strict; Secure; path=/'; }catch(_){ t='' } }
  const a=document.getElementById('csrf-login-token'); if(a) a.value = t;
  const b=document.getElementById('csrf-register-token'); if(b) b.value = t;
})();
</script>
</body>
</html>
