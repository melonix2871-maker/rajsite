<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
</head>
<body>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
  <img alt="Logo" width="36" height="36" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Crect width='36' height='36' rx='8' fill='%230066ff'/%3E%3Ctext x='18' y='23' font-size='16' text-anchor='middle' fill='white' font-family='Arial'%3EJ%3C/text%3E%3C/svg%3E">
  <span style="font-size:18px;font-weight:600">Admin Login</span>
</div>
<h1>Login</h1>
<div id="status" style="margin-bottom:12px"></div>
<div id="firebase-ui"></div>
<div style="margin-top:12px"><a href="index.html">Back to Home</a></div>
<!-- Firebase integration -->
<script src="/config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebaseui@6.1.0/dist/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firebaseui@6.1.0/dist/firebaseui.css"/>
<script>
async function initFirebaseLogin(){
  try{
    // Check if config.js loaded
    if(!window.__CONFIG || !window.__CONFIG.firebase){
      document.getElementById('status').textContent = '❌ Firebase not configured (config.js missing)';
      return;
    }

    // Initialize Firebase
    const firebaseConfig = window.__CONFIG.firebase;
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Initialize FirebaseUI
    const ui = new firebaseui.auth.AuthUI(auth);
    function isAdminUser(user){
      if(!user) return false;
      const allowedId = window.__CONFIG && window.__CONFIG.ADMIN_USER_ID;
      const allowedName = window.__CONFIG && window.__CONFIG.ADMIN_USERNAME;
      const uid = user.uid || '';
      const uname = user.displayName || user.email || '';
      return String(uid) === String(allowedId) || String(uname) === String(allowedName);
    }

    const uiConfig = {
      callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
          const user = authResult.user;
          const dest = isAdminUser(user) ? 'admin.html' : 'index.html';
          console.log('✅ User signed in:', user.uid, user.email, '→', dest);
          window.location.href = dest;
          return false;
        },
        uiShown: function() {
          document.getElementById('status').textContent = 'Ready to sign in...';
        }
      },
      signInFlow: 'popup',
      signInOptions: [
        {
          provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
          requireDisplayName: true
        },
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        firebase.auth.GithubAuthProvider.PROVIDER_ID
      ],
      privacyPolicyUrl: '#'
    };

    // Check current auth state
    auth.onAuthStateChanged(user => {
      if(user){
        // User is signed in
        document.getElementById('status').textContent = '✅ Signed in as: ' + (user.displayName || user.email);
        document.getElementById('firebase-ui').innerHTML = '<button onclick="firebase.auth().signOut(); location.reload();">Sign Out</button>';
        // Redirect based on admin status
        const dest = isAdminUser(user) ? 'admin.html' : 'index.html';
        setTimeout(() => { window.location.href = dest; }, 500);
      } else {
        // User is not signed in, show FirebaseUI
        document.getElementById('status').textContent = 'Not signed in';
        ui.start('#firebase-ui', uiConfig);
      }
    });
  }catch(e){ 
    document.getElementById('status').textContent = '❌ Auth initialization error'; 
    console.error('Firebase init error:', e);
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initFirebaseLogin);
</body>
</html>
