<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Data Table</title>
<style>
  body { font-family: sans-serif; padding: 16px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  button { padding: 4px 8px; margin-right: 4px; cursor: pointer; }
  #auth-bar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
  #row-form { border: 1px solid #ddd; padding: 12px; margin: 16px 0; }
  #row-form label { display: block; margin: 8px 0; }
  #row-form input { padding: 4px; width: 200px; }
  #row-form button { padding: 6px 12px; }
</style>
</head>
<body>
<div id="auth-bar">
  <span id="auth-status">Loading auth...</span>
  <button id="logout" style="display:none">Logout</button>
</div>

<div id="gist-token" style="margin-top:8px;display:none">
  <label>GitHub PAT (gist scope): <input type="password" id="gist-pat" placeholder="Paste PAT here"></label>
  <button id="set-pat">Set Token</button>
  <span id="token-status" style="margin-left:8px;color:#070"></span>
</div>

<h1>Data Table</h1>
<table>
  <thead>
    <tr>
      <th>id</th>
      <th>relid</th>
      <th>prefix</th>
      <th>collection</th>
      <th>metakey</th>
      <th>metavalue</th>
      <th>datecreated</th>
      <th>dateupdated</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<hr>
<h1>Add / Edit Record</h1>
<form id="row-form">
  <input type="hidden" id="id">
  <label>relid <input type="number" id="relid" required></label>
  <label>prefix <input type="text" id="prefix" placeholder="app_" required></label>
  <label>collection <input type="text" id="collection" required></label>
  <label>metakey <input type="text" id="metakey" required></label>
  <label>metavalue <input type="text" id="metavalue"></label>
  <button type="submit" id="submit-btn">Create</button>
  <button type="button" id="update-btn" style="display:none">Update</button>
  <button type="button" id="cancel-btn" style="display:none">Cancel</button>
</form>

<hr>
<h2>Import / Export</h2>
<div>
  <button id="export-json">üì• Export JSON</button>
  <button id="copy-json">üìã Copy JSON to Clipboard</button>
  <input type="file" id="import-json" accept="application/json">
  <p style="color: #666; font-size: 12px;">To persist to Gist: Copy JSON, then go to GitHub Actions ‚Üí "Update Gist" ‚Üí Run workflow ‚Üí Paste JSON.</p>
</div>

<script src="/config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script>
// In-memory PAT for Gist writes (never persisted)
let gistToken = null;

function setGistTokenFromInput(){
  const v = document.getElementById('gist-pat').value.trim();
  gistToken = v || null;
  document.getElementById('token-status').textContent = gistToken ? 'Token set' : '';
}

// Load from Gist (reads may work without token for public gist)
async function cloudLoad(token){
  try{
    const gid = window.__CONFIG && window.__CONFIG.GIST_ID;
    const fname = (window.__CONFIG && window.__CONFIG.GIST_FILENAME) || 'records.json';
    if(!gid) return null;
    const headers = token ? { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' } : { 'Accept': 'application/vnd.github.v3+json' };
    const resp = await fetch(`https://api.github.com/gists/${gid}`, { headers });
    if(!resp.ok) return null;
    const data = await resp.json();
    const content = data && data.files && data.files[fname] && data.files[fname].content;
    if(!content) return [];
    return JSON.parse(content);
  }catch(e){ console.error('cloudLoad error', e); return null; }
}

// Save to Gist (requires a PAT with gist scope)
async function cloudSave(records, token){
  try{
    const gid = window.__CONFIG && window.__CONFIG.GIST_ID;
    const fname = (window.__CONFIG && window.__CONFIG.GIST_FILENAME) || 'records.json';
    if(!gid) {
      alert('GIST_ID not configured ‚Äî cannot save.');
      return false;
    }
    if(!token) {
      alert('GitHub PAT required to save to Gist. Paste it into the PAT field and click Set Token.');
      return false;
    }
    const headers = { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };
    const body = JSON.stringify({ files: { [fname]: { content: JSON.stringify(records, null, 2) } } });
    const resp = await fetch(`https://api.github.com/gists/${gid}`, { method: 'PATCH', headers, body });
    if(!resp.ok){
      const txt = await resp.text().catch(()=>String(resp.status));
      alert('Save failed: ' + resp.status + ' ' + txt);
      return false;
    }
    return true;
  }catch(e){ console.error('cloudSave error', e); alert('Save error'); return false; }
}

// Rendering
function render(records) {
  const tb = document.querySelector('tbody');
  tb.innerHTML = '';
  for (const r of records) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id || ''}</td><td>${r.relid || ''}</td><td>${r.prefix || ''}</td><td>${r.collection || ''}</td><td>${r.metakey || ''}</td><td>${r.metavalue || ''}</td><td>${r.datecreated || ''}</td><td>${r.dateupdated || ''}</td><td><button data-action="edit" data-id="${r.id}">Edit</button> <button data-action="delete" data-id="${r.id}">Delete</button></td>`;
    tb.appendChild(tr);
  }
}

// Load and render initial data
async function ensure() {
  const cloud = await cloudLoad(gistToken);
  if (cloud) {
    render(cloud);
  } else {
    render([]);
  }
}

// Firebase Auth Guard
async function initFirebaseGuard() {
  try {
    // Check if config.js loaded
    if (!window.__CONFIG || !window.__CONFIG.firebase) {
      document.getElementById('auth-status').textContent = '‚ùå Auth not configured';
      return;
    }

    // Initialize Firebase
    const firebaseConfig = window.__CONFIG.firebase;
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Wait for auth state
    const user = await new Promise(resolve => {
      const unsubscribe = auth.onAuthStateChanged(user => {
        unsubscribe();
        resolve(user);
      });
    });

    // Not signed in ‚Üí redirect to login
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    // Check if user is admin
    const allowedId = window.__CONFIG.ADMIN_USER_ID;
    const allowedName = window.__CONFIG.ADMIN_USERNAME;
    const uid = user.uid || '';
    const uname = user.displayName || user.email || '';

    if (String(uid) !== String(allowedId) && String(uname) !== String(allowedName)) {
      // Not an admin ‚Üí redirect to public index
      window.location.href = 'index.html';
      return;
    }

    // Admin user confirmed
    document.getElementById('auth-status').textContent = '‚úÖ Signed in as: ' + (user.displayName || user.email || '');
    document.getElementById('logout').style.display = '';
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (_e) { }
      window.location.href = 'login.html';
    });

    // Show PAT input for admin to allow saving to gist
    document.getElementById('gist-token').style.display = '';
    document.getElementById('set-pat').addEventListener('click', ()=> setGistTokenFromInput());

  } catch (_e) {
    document.getElementById('auth-status').textContent = '‚ùå Auth error';
    console.error('Firebase guard init error:', _e);
    window.location.href = 'login.html';
  }
}

// Initialize
initFirebaseGuard();

// Create
document.getElementById('row-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const relid = Number(document.getElementById('relid').value.trim());
  const prefix = document.getElementById('prefix').value.trim();
  const collection = document.getElementById('collection').value.trim();
  const metakey = document.getElementById('metakey').value.trim();
  const metavalue = document.getElementById('metavalue').value.trim();

  if (!Number.isFinite(relid) || !prefix || !collection || !metakey) return;

  let records = await cloudLoad(gistToken);
  if (!records) records = [];

  const id = crypto.randomUUID();
  const now = new Date().toISOString();
  const rec = { id, relid, prefix, collection, metakey, metavalue, datecreated: now, dateupdated: now };
  records.push(rec);

  // Persist to Gist (requires PAT set by admin)
  await cloudSave(records, gistToken);
  render(records);
  e.target.reset();
});

// Edit / Delete handlers
document.querySelector('tbody').addEventListener('click', async (e) => {
  const t = e.target;
  if (!(t instanceof Element)) return;
  const a = t.getAttribute('data-action');
  if (!a) return;
  const id = t.getAttribute('data-id');

  let records = await cloudLoad(gistToken);
  if (!records) records = [];

  if (a === 'delete') {
    records = records.filter(x => x.id !== id);
    await cloudSave(records, gistToken);
    render(records);
    return;
  }

  if (a === 'edit') {
    const r = records.find(x => x.id === id);
    if (!r) return;
    document.getElementById('id').value = r.id;
    document.getElementById('relid').value = r.relid || '';
    document.getElementById('prefix').value = r.prefix || '';
    document.getElementById('collection').value = r.collection || '';
    document.getElementById('metakey').value = r.metakey || '';
    document.getElementById('metavalue').value = r.metavalue || '';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('update-btn').style.display = '';
    document.getElementById('cancel-btn').style.display = '';
  }
});

// Update
document.getElementById('update-btn').addEventListener('click', async () => {
  const id = document.getElementById('id').value;
  let records = await cloudLoad(gistToken);
  if (!records) records = [];

  const idx = records.findIndex(x => x.id === id);
  if (idx !== -1) {
    const now = new Date().toISOString();
    records[idx].relid = Number(document.getElementById('relid').value.trim());
    records[idx].prefix = document.getElementById('prefix').value.trim();
    records[idx].collection = document.getElementById('collection').value.trim();
    records[idx].metakey = document.getElementById('metakey').value.trim();
    records[idx].metavalue = document.getElementById('metavalue').value.trim();
    records[idx].dateupdated = now;

    await cloudSave(records, gistToken);
    render(records);

    // Clear form
    document.getElementById('id').value = '';
    document.getElementById('relid').value = '';
    document.getElementById('prefix').value = '';
    document.getElementById('collection').value = '';
    document.getElementById('metakey').value = '';
    document.getElementById('metavalue').value = '';
    document.getElementById('submit-btn').style.display = '';
    document.getElementById('update-btn').style.display = 'none';
    document.getElementById('cancel-btn').style.display = 'none';
  }
});

// Cancel
document.getElementById('cancel-btn').addEventListener('click', () => {
  document.getElementById('id').value = '';
  document.getElementById('relid').value = '';
  document.getElementById('prefix').value = '';
  document.getElementById('collection').value = '';
  document.getElementById('metakey').value = '';
  document.getElementById('metavalue').value = '';
  document.getElementById('submit-btn').style.display = '';
  document.getElementById('update-btn').style.display = 'none';
  document.getElementById('cancel-btn').style.display = 'none';
});

// Export
document.getElementById('export-json').addEventListener('click', () => {
  cloudLoad(gistToken).then(list => {
    const data = JSON.stringify(list || [], null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'records.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });
});

// Import
document.getElementById('import-json').addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const list = JSON.parse(String(reader.result));
      if (Array.isArray(list)) {
        // Persist imported list to Gist
        cloudSave(list, gistToken).then(ok => {
          if(ok) render(list);
        });
      }
    } catch (_e) { }
    e.target.value = '';
  };
  reader.readAsText(f);
});

// Copy to clipboard
document.getElementById('copy-json').addEventListener('click', () => {
  cloudLoad(gistToken).then(list => {
    const data = JSON.stringify(list || [], null, 2);
    navigator.clipboard.writeText(data).then(() => {
      alert('‚úÖ JSON copied to clipboard!');
    }).catch(() => {
      alert('‚ùå Copy failed ‚Äî use Export JSON instead.');
    });
  });
});

// Load initial data
ensure();
</script>
</body>
</html>
