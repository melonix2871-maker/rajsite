<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin</title>

</head>
<body>
<div id="auth-bar" style="display:flex;gap:12px;align-items:center">
  <span id="auth-status"></span>
  <button id="logout" style="display:none">Logout</button>
</div>
<h1>Add Record</h1>
<form id="row-form">
  <label>relid <input type="number" id="relid" required></label>
  <label>prefix <input type="text" id="prefix" placeholder="app_" required></label>
  <label>collection <input type="text" id="collection" required></label>
  <label>metakey <input type="text" id="metakey" required></label>
  <label>metavalue <input type="text" id="metavalue"></label>
  <button type="submit">Create</button>
</form>
<div id="status" style="margin-top:12px"></div>
<div style="margin-top:8px;color:#333">CoreEngineDB-backed admin. Changes are persisted to the remote JSON.</div>
<script>
const WRITE_DB_URL = 'https://assets.antserver1.eu.org/db.json'
function getCoreUrls(){ return { dbUrl: WRITE_DB_URL } }
function requireSession(){ const auth=sessionStorage.getItem('cedb_auth')||''; if(!auth){ window.location.href='login.html'; return null } return auth }
function setAuthedUI(){ document.getElementById('auth-status').textContent='✅ Session active'; document.getElementById('logout').style.display=''; document.getElementById('logout').addEventListener('click',()=>{ try{ sessionStorage.removeItem('cedb_auth') }catch(_e){} window.location.href='login.html' }) }
async function readRemote(){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return []; const r=await fetch(dbUrl,{ cache:'no-store', mode:'cors', credentials:'omit', headers:{ 'Authorization':auth } }); if(!r.ok) return []; const et=r.headers.get('etag'); if(et) window.cedbEtag = et; const t=await r.text(); try{ return JSON.parse(t) }catch(_){ return [] } }catch(_e){ return [] } }
async function writeRemote(records, opts){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return false; const et=window.cedbEtag||''; const headers=Object.assign({ 'Content-Type':'application/json', 'Authorization':auth }, et?{ 'If-Match': et }: {}, (opts&&opts.allowEmpty)? { 'X-Allow-Empty-Write':'true' } : {}); const body=JSON.stringify(records,null,2); const r=await fetch(dbUrl,{ method:'PUT', headers, body, mode:'cors', credentials:'omit' }); if(r.status===412) { document.getElementById('status').textContent='❌ Conflict — refresh and retry'; return false } if(!r.ok) { document.getElementById('status').textContent='❌ Write failed'; return false } const newEt=r.headers.get('etag'); if(newEt) window.cedbEtag = newEt; return true }catch(_e){ document.getElementById('status').textContent='❌ Write error'; return false } }
setAuthedUI();

function nextId(){ return crypto.randomUUID(); }

document.getElementById('row-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const relid = Number(document.getElementById('relid').value.trim());
  const prefix = document.getElementById('prefix').value.trim();
  const collection = document.getElementById('collection').value.trim();
  const metakey = document.getElementById('metakey').value.trim();
  const metavalue = document.getElementById('metavalue').value.trim();
  if(!Number.isFinite(relid) || !prefix || !collection || !metakey) return;
  let records = await readRemote();
  if(!records) records = [];
  const id = nextId();
  const now = new Date().toISOString();
  const rec = { id, relid, prefix, collection, metakey, metavalue, datecreated: now, dateupdated: now };
  records.push(rec);
  const ok = await writeRemote(records);
  if(ok){
    document.getElementById('status').textContent = 'Saved to CoreEngineDB.';
    e.target.reset();
  } else {
    document.getElementById('status').textContent = 'Save failed — check credentials or conflicts.';
  }
});
</script>
</body>
</html>
