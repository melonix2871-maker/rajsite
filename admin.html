<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin</title>

</head>
<body>
<div id="auth-bar" style="display:flex;gap:12px;align-items:center">
  <span id="auth-status"></span>
  <button id="logout" style="display:none">Logout</button>
</div>
<h1>Add Record</h1>
<form id="row-form">
  <input type="hidden" id="csrf-admin-token" name="csrf_token">
  <label>relid <input type="number" id="relid" required></label>
  <label>prefix <input type="text" id="prefix" placeholder="app_" required></label>
  <label>collection <input type="text" id="collection" required></label>
  <label>metakey <input type="text" id="metakey" required></label>
  <label>metavalue <input type="text" id="metavalue"></label>
  <button type="submit">Create</button>
</form>
<div id="status" style="margin-top:12px"></div>
<div style="margin-top:8px;color:#333">CoreEngineDB-backed admin. Changes are persisted to the remote JSON.</div>
<div style="margin-top:20px">
  <h2>Stripe Settings</h2>
  <form id="stripe-form" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
    <div><label>Publishable Key <input id="stripe-pub" placeholder="pk_live_..." /></label></div>
    <div><label>Bottle Price ID <input id="stripe-price-bottle" placeholder="price_..." /></label></div>
    <div><label>Bucket Price ID <input id="stripe-price-bucket" placeholder="price_..." /></label></div>
    <div><label>Case Price ID <input id="stripe-price-case" placeholder="price_..." /></label></div>
    <div><small style="color:#555">Secret key is managed server-side in Worker environment and never stored in public config.</small></div>
    <div style="grid-column:1/-1"><button id="stripe-save">Save Stripe Settings</button> <span id="stripe-msg" style="margin-left:8px"></span></div>
  </form>
</div>
<script>
const WRITE_DB_URL = (function(){ try{ if(window.__REMOTE && window.__REMOTE.dbUrl) return String(window.__REMOTE.dbUrl) }catch(_){} return atob('aHR0cHM6Ly9jb3JlZW5naW5lZGIubWVvYXNpczIwMTQud29ya2Vycy5kZXYvanNvbi9kYi5qc29u') })()
const WORKER_CONFIG_URL = (function(){ try{ if(window.__REMOTE && window.__REMOTE.configUrl) return String(window.__REMOTE.configUrl) }catch(_){} return atob('aHR0cHM6Ly9jb3JlZW5naW5lZGIubWVvYXNpczIwMTQud29ya2Vycy5kZXYvanNvbi9jb25maWcuanNvbg==') })()
function getCoreUrls(){ return { dbUrl: WRITE_DB_URL } }
function requireSession(){
  const app = (function(){ try{ return JSON.parse(sessionStorage.getItem('app_auth')||'null') }catch(_){ return null } })()
  if(!app || String(app.role||'')!=='superadmin'){
    window.location.href='/login.html'
    return null
  }
  const auth=sessionStorage.getItem('cedb_auth')||''
  if(!auth){ window.location.href='/login.html'; return null }
  return auth
}
function setAuthedUI(){ document.getElementById('auth-status').textContent='✅ Session active'; document.getElementById('logout').style.display=''; document.getElementById('logout').addEventListener('click',()=>{ try{ sessionStorage.removeItem('cedb_auth'); sessionStorage.removeItem('app_auth') }catch(_e){} window.location.href='login.html' }) }
async function readRemote(){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return []; const r=await fetch(dbUrl,{ cache:'no-store', mode:'cors', credentials:'omit', headers:{ 'Authorization':auth } }); if(!r.ok) return []; const et=r.headers.get('etag'); if(et) window.cedbEtag = et; const t=await r.text(); try{ return JSON.parse(t) }catch(_){ return [] } }catch(_e){ return [] } }
async function writeRemote(records, opts){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return false; const et=window.cedbEtag||''; const csrf=(sessionStorage.getItem('csrf_token')||''); const headers=Object.assign({ 'Content-Type':'application/json', 'Authorization':auth, 'X-CSRF-Token': csrf }, et?{ 'If-Match': et }: {}, (opts&&opts.allowEmpty)? { 'X-Allow-Empty-Write':'true' } : {}); const body=JSON.stringify(records,null,2); const r=await fetch(dbUrl,{ method:'PUT', headers, body, mode:'cors', credentials:'omit' }); if(r.status===412) { document.getElementById('status').textContent='❌ Conflict — refresh and retry'; return false } if(!r.ok) { document.getElementById('status').textContent='❌ Write failed'; return false } const newEt=r.headers.get('etag'); if(newEt) window.cedbEtag = newEt; return true }catch(_e){ document.getElementById('status').textContent='❌ Write error'; return false } }
(function(){ if(requireSession()){ setAuthedUI() } })();

function nextId(){ return crypto.randomUUID(); }

document.getElementById('row-form').addEventListener('submit', async e=>{
  e.preventDefault();
  let csrf=sessionStorage.getItem('csrf_token');
  if(!csrf){ try{ const a=new Uint8Array(32); crypto.getRandomValues(a); csrf=Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); sessionStorage.setItem('csrf_token', csrf); document.cookie='csrf_token='+csrf+'; SameSite=Strict; Secure; path=/'; }catch(_){ csrf='' } }
  const hv=document.getElementById('csrf-admin-token');
  const cv=(document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith('csrf_token='))||'').split('=')[1]||'';
  if(hv){ hv.value = csrf }
  if(!csrf || !cv || csrf!==cv){ document.getElementById('status').textContent='❌ Invalid CSRF token'; return }
  const relid = Number(document.getElementById('relid').value.trim());
  const prefix = document.getElementById('prefix').value.trim();
  const collection = document.getElementById('collection').value.trim();
  const metakey = document.getElementById('metakey').value.trim();
  const metavalue = document.getElementById('metavalue').value.trim();
  if(!Number.isFinite(relid) || !prefix || !collection || !metakey) return;
  let records = await readRemote();
  if(!records) records = [];
  const id = nextId();
  const now = new Date().toISOString();
  const rec = { id, relid, prefix, collection, metakey, metavalue, datecreated: now, dateupdated: now };
  records.push(rec);
  const ok = await writeRemote(records);
  if(ok){
    document.getElementById('status').textContent = 'Saved to CoreEngineDB.';
    e.target.reset();
  } else {
    document.getElementById('status').textContent = 'Save failed — check credentials or conflicts.';
  }
});

async function loadStripe(){ try{ const r=await fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization': requireSession()||'' } }); const j=r.ok? await r.json():{}; const s=j&&j.stripe||{}; document.getElementById('stripe-pub').value = s.publishableKey||''; const p=(s.prices)||{}; document.getElementById('stripe-price-bottle').value = p.bottle||''; document.getElementById('stripe-price-bucket').value = p.bucket||''; document.getElementById('stripe-price-case').value = p.case||''; }catch(_){ }
}
async function sha256Hex(s){ const d=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(String(s||''))); return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('') }
async function saveStripe(){ try{ const auth=requireSession()||''; const cfgRes=await fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization': auth } }); const cfgText=cfgRes.ok? await cfgRes.text(): '{}'; const et=await sha256Hex(cfgText); let cur={}; try{ cur=JSON.parse(cfgText||'{}') }catch(_){ cur={} } const payloadStripe={ publishableKey: document.getElementById('stripe-pub').value.trim(), prices: { bottle: document.getElementById('stripe-price-bottle').value.trim(), bucket: document.getElementById('stripe-price-bucket').value.trim(), case: document.getElementById('stripe-price-case').value.trim() } }; cur.stripe = payloadStripe; let res = await fetch(WORKER_CONFIG_URL,{ method:'PUT', headers: { 'Content-Type':'application/json', 'Authorization': auth, 'If-Match': et }, body: JSON.stringify(cur,null,2) }); if(res.status===412){ const cfgRes2=await fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization': auth } }); const cfgText2=cfgRes2.ok? await cfgRes2.text(): '{}'; const et2=await sha256Hex(cfgText2); let cur2={}; try{ cur2=JSON.parse(cfgText2||'{}') }catch(_){ cur2={} } cur2.stripe = payloadStripe; res = await fetch(WORKER_CONFIG_URL,{ method:'PUT', headers: { 'Content-Type':'application/json', 'Authorization': auth, 'If-Match': et2 }, body: JSON.stringify(cur2,null,2) }); if(res.status===412){ await fetch('https://coreenginedb.meoasis2014.workers.dev/json/sync', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': auth }, body: JSON.stringify({ type:'config', data: cur2 }, null, 2) }); res = new Response(null, { status:200 }); } }
document.getElementById('stripe-msg').textContent = res.ok? 'Saved' : (res.status===412? 'Conflict — please retry' : 'Save failed')
}catch(_){ document.getElementById('stripe-msg').textContent='Error' }
}
loadStripe()
document.getElementById('stripe-save').addEventListener('click', function(e){ e.preventDefault(); saveStripe() })
</script>
<script>
async function renderMonitoring(){ try{ const auth=requireSession(); if(!auth) return; const r=await fetch(WRITE_DB_URL,{ cache:'no-store', headers:{ 'Authorization':auth } }); const rows = r.ok? await r.json() : []; const byUser = {}; const byPost = []; const donations = {}; const wallets = {}; (Array.isArray(rows)?rows:[]).forEach(rec=>{
  const p=String(rec.prefix||''), c=String(rec.collection||''), k=String(rec.metakey||'');
  if(p==='app_' && c==='users' && k==='username'){ byUser[rec.relid||0] = { username: String(rec.metavalue||'') } }
  if(p==='app_' && c==='users' && k==='avatar'){ const u=byUser[rec.relid||0]||{}; u.avatar=String(rec.metavalue||''); byUser[rec.relid||0]=u }
  if(p==='app_' && c==='posts' && k==='content'){ byPost.push(rec) }
  if(p==='donate_' && c==='post'){ const pid=rec.relid||0; const dk=String(rec.metakey||''); const v=Number(rec.metavalue||0)||0; donations[pid] = donations[pid]||{ bottles:0,buckets:0,cases:0 }; if(dk==='bottles') donations[pid].bottles+=v; if(dk==='buckets') donations[pid].buckets+=v; if(dk==='cases') donations[pid].cases+=v }
  if(p==='wallet_' && c==='balance' && k==='amount'){ wallets[rec.relid||0] = Number(rec.metavalue||0)||0 }
  if(p==='wallet_' && c==='ledger'){ const rel=rec.relid||0; wallets[rel] = wallets[rel]||0 }
});
  const mount = document.createElement('div'); mount.style.marginTop='20px';
  const totalUsers = Object.keys(byUser).length; const totalPosts = byPost.length; const totalDonations = Object.values(donations).reduce((m,d)=>m + d.bottles*5 + d.buckets*30 + d.cases*60,0);
  mount.innerHTML = `<h2>Monitoring</h2><div class="grid"><div><div class="muted">Users</div><div class="badge">${totalUsers}</div></div><div><div class="muted">Posts</div><div class="badge">${totalPosts}</div></div><div><div class="muted">Donations (USD)</div><div class="badge">$${totalDonations.toFixed(2)}</div></div></div><div style="margin-top:12px"><h3>Users</h3><table><thead><tr><th>relid</th><th>username</th><th>balance</th></tr></thead><tbody>${Object.entries(byUser).map(([rel,u])=>`<tr><td>${rel}</td><td>${u.username||''}</td><td>$${(wallets[rel]||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div><div style="margin-top:12px"><h3>Posts</h3><table><thead><tr><th>id</th><th>relid</th><th>content</th><th>raised</th></tr></thead><tbody>${byPost.map(p=>{ const d=donations[p.id||0]||{bottles:0,buckets:0,cases:0}; const total=d.bottles*5 + d.buckets*30 + d.cases*60; const txt=(typeof p.metavalue==='object')? JSON.stringify(p.metavalue) : String(p.metavalue||''); return `<tr><td>${p.id}</td><td>${p.relid}</td><td>${txt}</td><td>$${total.toFixed(2)}</td></tr>` }).join('')}</tbody></table></div>`;
  document.body.appendChild(mount);
}catch(_){ }
}
renderMonitoring()
</script>
<script>
function el(tag, attrs={}, children=[]) { const e=document.createElement(tag); Object.entries(attrs||{}).forEach(([k,v])=>{ if(k==='class') e.className=v; else e.setAttribute(k,v) }); children.forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c) }); return e }
async function fetchAll(){ const auth=requireSession(); if(!auth) return { rows:[], cfg:{}, acts:[] }; const [rowsRes,cfgRes,dayRes] = await Promise.all([
  fetch(WRITE_DB_URL,{ cache:'no-store', headers:{ 'Authorization':auth } }),
  fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization':auth } }),
  fetch('https://coreenginedb.meoasis2014.workers.dev/activity?day='+new Date().toISOString().slice(0,10)+'&limit=500')
]); const rows = rowsRes.ok? await rowsRes.json():[]; const cfg = cfgRes.ok? await cfgRes.json():{}; const acts = dayRes.ok? await dayRes.json():[]; return { rows:Array.isArray(rows)?rows:[], cfg: (cfg||{}), acts: Array.isArray(acts)?acts:[] }
}
function compute(rows){ const users={}, posts=[], donations={}, wallets={}, withdrawals=[]; rows.forEach(rec=>{ const p=String(rec.prefix||''), c=String(rec.collection||''), k=String(rec.metakey||''); if(p==='app_'&&c==='users'&&k==='username'){ users[rec.relid||0]=Object.assign(users[rec.relid||0]||{}, { username:String(rec.metavalue||'') }) } if(p==='app_'&&c==='users'&&k==='avatar'){ users[rec.relid||0]=Object.assign(users[rec.relid||0]||{}, { avatar:String(rec.metavalue||'') }) } if(p==='app_'&&c==='posts'&&k==='content'){ posts.push(rec) } if(p==='donate_'&&c==='post'){ const pid=rec.relid||0; const dk=String(k); const v=Number(rec.metavalue||0)||0; donations[pid]=donations[pid]||{ bottles:0,buckets:0,cases:0 }; if(dk==='bottles') donations[pid].bottles+=v; if(dk==='buckets') donations[pid].buckets+=v; if(dk==='cases') donations[pid].cases+=v } if(p==='wallet_'&&c==='balance'&&k==='amount'){ wallets[rec.relid||0]=Number(rec.metavalue||0)||0 } if(p==='withdraw_'&&c==='requests'){ withdrawals.push(rec) } }); return { users, posts, donations, wallets, withdrawals }
}
function renderTabs(root){ const tabs=['Users','Posts','Donations','Wallets','Withdrawals','Activity','Stripe']; const bar=el('div',{ class:'toolbar', id:'mon-tabs', style:'border-bottom:1px solid #eee;margin-top:20px' }, tabs.map(t=>el('button',{ class:'secondary', 'data-tab':t },[t]))); const panel=el('div',{ id:'mon-panel' },[]); root.appendChild(bar); root.appendChild(panel); bar.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; const tab=b.getAttribute('data-tab'); root.dispatchEvent(new CustomEvent('switch',{ detail:{ tab } })) }); return { bar, panel } }
function table(headers, rows){ const t=el('table',{},[]); const thead=el('thead',{},[ el('tr',{}, headers.map(h=>el('th',{},[h])) ) ]); const tbody=el('tbody',{}, rows.map(r=> el('tr',{}, r.map(c=> el('td',{},[ String(c) ]) )) )); t.appendChild(thead); t.appendChild(tbody); return t }
async function renderAll(){ const mount=document.createElement('div'); document.body.appendChild(mount); const { rows, cfg, acts } = await fetchAll(); const { users, posts, donations, wallets, withdrawals } = compute(rows); const { bar, panel } = renderTabs(mount);
  function show(tab){ panel.innerHTML=''; if(tab==='Users'){ const hdr=['relid','username','balance']; const data=Object.entries(users).map(([rel,u])=>[rel, u.username||'', '$'+(wallets[rel]||0).toFixed(2)]); panel.appendChild(table(hdr,data)) }
  else if(tab==='Posts'){ const hdr=['id','relid','content','raised']; const data=posts.map(p=>{ const d=donations[p.id||0]||{ bottles:0,buckets:0,cases:0 }; const total=d.bottles*5 + d.buckets*30 + d.cases*60; const txt=(typeof p.metavalue==='object')? JSON.stringify(p.metavalue) : String(p.metavalue||''); return [p.id, p.relid, txt, '$'+total.toFixed(2)] }); panel.appendChild(table(hdr,data)) }
  else if(tab==='Donations'){ const hdr=['postId','bottles','buckets','cases','total']; const data=Object.entries(donations).map(([pid,d])=>[pid, d.bottles, d.buckets, d.cases, '$'+(d.bottles*5 + d.buckets*30 + d.cases*60).toFixed(2)]); panel.appendChild(table(hdr,data)) }
  else if(tab==='Wallets'){ const hdr=['relid','balance']; const data=Object.entries(wallets).map(([rel,bal])=>[rel, '$'+Number(bal||0).toFixed(2)]); panel.appendChild(table(hdr,data)) }
  else if(tab==='Withdrawals'){ const hdr=['id','relid','amount','status','created']; const data=withdrawals.map(w=>[w.id, w.relid, String(w.metavalue&&w.metavalue.amount||''), String(w.metavalue&&w.metavalue.status||''), w.createddate||'']); panel.appendChild(table(hdr,data)) }
  else if(tab==='Activity'){ const hdr=['ts','method','path','status','user','reason']; const data=(acts||[]).map(a=>[a.ts||'', a.method||'', a.path||'', a.status||'', a.user||'', a.reason||'']); panel.appendChild(table(hdr,data)) }
  else if(tab==='Stripe'){ const pk = (cfg && cfg.stripe && cfg.stripe.publishableKey) || ''; const pr = (cfg && cfg.stripe && cfg.stripe.prices) || {}; const card=el('div',{},[ el('div',{ class:'muted' },['Publishable Key']), el('div',{ class:'badge' },[pk||'(not set)']), el('div',{ class:'muted', style:'margin-top:12px' },['Prices']), el('div',{},[ 'Bottle: ', pr.bottle||'', ' • Bucket: ', pr.bucket||'', ' • Case: ', pr.case||'' ]) ]); panel.appendChild(card) }
  }
  mount.addEventListener('switch', (e)=> show(e.detail.tab)); show('Users')
}
renderAll()
</script>
</body>
</html>
