<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin</title>
</head>
<body>
<div id="auth-bar" style="display:flex;gap:12px;align-items:center">
  <span id="auth-status"></span>
  <button id="logout" style="display:none">Logout</button>
</div>
<h1>Add Record</h1>
<form id="row-form">
  <label>RelID <input type="number" id="relid" required></label>
  <label>Prefix <input type="text" id="prefix" placeholder="e.g. app_" required></label>
  <label>Collection <input type="text" id="collection" required></label>
  <label>Meta Key <input type="text" id="metakey" required></label>
  <label>Meta Value <input type="text" id="metavalue"></label>
  <button type="submit">Create</button>
</form>
<div id="status" style="margin-top:12px"></div>
<div style="margin-top:12px"><a href="db.html">Open Data Table</a></div>
<script src="https://js.puter.com/v2/"></script>
<script>
async function guard(){
  try{
    if(!puter.auth.isSignedIn()){ window.location.href='login.html'; return; }
    const u = await puter.auth.getUser();
    const s = document.getElementById('auth-status');
    s.textContent = 'Signed in as: ' + (u&&u.username||'');
    document.getElementById('logout').style.display='';
  }catch(_e){ window.location.href='login.html'; return; }
}
document.getElementById('logout').addEventListener('click', async ()=>{ try{ await puter.auth.signOut(); }catch(_e){} window.location.href='login.html'; });
guard();
const KEY='records';
async function cloudLoad(){try{const b=await puter.fs.read('records.json');const t=await b.text();const j=JSON.parse(t);if(Array.isArray(j))return j}catch(_e){}return null}
async function cloudSave(records){try{await puter.fs.write('records.json',new Blob([JSON.stringify(records)],{type:'application/json'}))}catch(_e){}}
function load(){const s=localStorage.getItem(KEY);return s?JSON.parse(s):[]}
function save(records){localStorage.setItem(KEY,JSON.stringify(records))}
function nextSeq(records){let m=0;for(const r of records){const v=Number(r.seq)||0;if(v>m)m=v}return m+1}
document.getElementById('row-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const relidVal = document.getElementById('relid').value.trim();
  const prefix = document.getElementById('prefix').value.trim();
  const collection = document.getElementById('collection').value.trim();
  const metakey = document.getElementById('metakey').value.trim();
  const metavalue = document.getElementById('metavalue').value.trim();
  if(!relidVal || !prefix || !collection || !metakey) return;
  let records = await cloudLoad();
  if(!records) records = load();
  const id = crypto.randomUUID();
  const now = new Date().toISOString();
  records.push({id,relid:Number(relidVal),prefix,collection,metakey,metavalue,datecreated:now,dateupdated:now});
  save(records);
  await cloudSave(records);
  document.getElementById('status').textContent = 'Saved. id '+id;
  e.target.reset();
})
</script>
</body>
</html>
