<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin</title>

</head>
<body>
<div id="auth-bar" style="display:flex;gap:12px;align-items:center">
  <span id="auth-status"></span>
  <button id="logout" style="display:none">Logout</button>
</div>
<h1>Add Record</h1>
<form id="row-form">
  <input type="hidden" id="csrf-admin-token" name="csrf_token">
  <label>relid <input type="number" id="relid" required></label>
  <label>prefix <input type="text" id="prefix" placeholder="app_" required></label>
  <label>collection <input type="text" id="collection" required></label>
  <label>metakey <input type="text" id="metakey" required></label>
  <label>metavalue <input type="text" id="metavalue"></label>
  <button type="submit">Create</button>
</form>
<div id="status" style="margin-top:12px"></div>
<div style="margin-top:8px;color:#333">CoreEngineDB-backed admin. Changes are persisted to the remote JSON.</div>
<div style="margin-top:20px">
  <h2>Stripe Settings</h2>
  <form id="stripe-form" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
    <div><label>Publishable Key <input id="stripe-pub" placeholder="pk_live_..." /></label></div>
    <div><label>Bottle Price ID <input id="stripe-price-bottle" placeholder="price_..." /></label></div>
    <div><label>Bucket Price ID <input id="stripe-price-bucket" placeholder="price_..." /></label></div>
    <div><label>Case Price ID <input id="stripe-price-case" placeholder="price_..." /></label></div>
    <div><small style="color:#555">Secret key is managed server-side in Worker environment and never stored in public config.</small></div>
    <div style="grid-column:1/-1"><button id="stripe-save">Save Stripe Settings</button> <span id="stripe-msg" style="margin-left:8px"></span></div>
  </form>
</div>
<script>
const WRITE_DB_URL = (function(){ try{ if(window.__REMOTE && window.__REMOTE.dbUrl) return String(window.__REMOTE.dbUrl) }catch(_){} return atob('aHR0cHM6Ly9jb3JlZW5naW5lZGIubWVvYXNpczIwMTQud29ya2Vycy5kZXYvanNvbi9kYi5qc29u') })()
const WORKER_CONFIG_URL = (function(){ try{ if(window.__REMOTE && window.__REMOTE.configUrl) return String(window.__REMOTE.configUrl) }catch(_){} return atob('aHR0cHM6Ly9jb3JlZW5naW5lZGIubWVvYXNpczIwMTQud29ya2Vycy5kZXYvanNvbi9jb25maWcuanNvbg==') })()
function getCoreUrls(){ return { dbUrl: WRITE_DB_URL } }
function requireSession(){
  const app = (function(){ try{ return JSON.parse(sessionStorage.getItem('app_auth')||'null') }catch(_){ return null } })()
  if(!app || String(app.role||'')!=='superadmin'){
    window.location.href='/login.html'
    return null
  }
  const auth=sessionStorage.getItem('cedb_auth')||''
  if(!auth){ window.location.href='/login.html'; return null }
  return auth
}
function setAuthedUI(){ document.getElementById('auth-status').textContent='✅ Session active'; document.getElementById('logout').style.display=''; document.getElementById('logout').addEventListener('click',()=>{ try{ sessionStorage.removeItem('cedb_auth'); sessionStorage.removeItem('app_auth') }catch(_e){} window.location.href='login.html' }) }
async function readRemote(){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return []; const r=await fetch(dbUrl,{ cache:'no-store', mode:'cors', credentials:'omit', headers:{ 'Authorization':auth } }); if(!r.ok) return []; const et=r.headers.get('etag'); if(et) window.cedbEtag = et; const t=await r.text(); try{ return JSON.parse(t) }catch(_){ return [] } }catch(_e){ return [] } }
async function writeRemote(records, opts){ try{ const {dbUrl}=getCoreUrls(); const auth=requireSession(); if(!auth) return false; const et=window.cedbEtag||''; const csrf=(sessionStorage.getItem('csrf_token')||''); const headers=Object.assign({ 'Content-Type':'application/json', 'Authorization':auth, 'X-CSRF-Token': csrf }, et?{ 'If-Match': et }: {}, (opts&&opts.allowEmpty)? { 'X-Allow-Empty-Write':'true' } : {}); const body=JSON.stringify(records,null,2); const r=await fetch(dbUrl,{ method:'PUT', headers, body, mode:'cors', credentials:'omit' }); if(r.status===412) { document.getElementById('status').textContent='❌ Conflict — refresh and retry'; return false } if(!r.ok) { document.getElementById('status').textContent='❌ Write failed'; return false } const newEt=r.headers.get('etag'); if(newEt) window.cedbEtag = newEt; return true }catch(_e){ document.getElementById('status').textContent='❌ Write error'; return false } }
(function(){ if(requireSession()){ setAuthedUI() } })();

function nextId(){ return crypto.randomUUID(); }

document.getElementById('row-form').addEventListener('submit', async e=>{
  e.preventDefault();
  let csrf=sessionStorage.getItem('csrf_token');
  if(!csrf){ try{ const a=new Uint8Array(32); crypto.getRandomValues(a); csrf=Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); sessionStorage.setItem('csrf_token', csrf); document.cookie='csrf_token='+csrf+'; SameSite=Strict; Secure; path=/'; }catch(_){ csrf='' } }
  const hv=document.getElementById('csrf-admin-token');
  const cv=(document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith('csrf_token='))||'').split('=')[1]||'';
  if(hv){ hv.value = csrf }
  if(!csrf || !cv || csrf!==cv){ document.getElementById('status').textContent='❌ Invalid CSRF token'; return }
  const relid = Number(document.getElementById('relid').value.trim());
  const prefix = document.getElementById('prefix').value.trim();
  const collection = document.getElementById('collection').value.trim();
  const metakey = document.getElementById('metakey').value.trim();
  const metavalue = document.getElementById('metavalue').value.trim();
  if(!Number.isFinite(relid) || !prefix || !collection || !metakey) return;
  let records = await readRemote();
  if(!records) records = [];
  const id = nextId();
  const now = new Date().toISOString();
  const rec = { id, relid, prefix, collection, metakey, metavalue, datecreated: now, dateupdated: now };
  records.push(rec);
  const ok = await writeRemote(records);
  if(ok){
    document.getElementById('status').textContent = 'Saved to CoreEngineDB.';
    e.target.reset();
  } else {
    document.getElementById('status').textContent = 'Save failed — check credentials or conflicts.';
  }
});

async function loadStripe(){ try{ const r=await fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization': requireSession()||'' } }); const j=r.ok? await r.json():{}; const s=j&&j.stripe||{}; document.getElementById('stripe-pub').value = s.publishableKey||''; const p=(s.prices)||{}; document.getElementById('stripe-price-bottle').value = p.bottle||''; document.getElementById('stripe-price-bucket').value = p.bucket||''; document.getElementById('stripe-price-case').value = p.case||''; }catch(_){ }
}
async function saveStripe(){ try{ const head=await fetch(WORKER_CONFIG_URL,{ method:'HEAD' }); const et=head.headers.get('etag')||''; const r=await fetch(WORKER_CONFIG_URL,{ cache:'no-store', headers:{ 'Authorization': requireSession()||'' } }); const j=r.ok? await r.json():{}; if(!j.stripe) j.stripe={}; j.stripe.publishableKey = document.getElementById('stripe-pub').value.trim(); j.stripe.prices = { bottle: document.getElementById('stripe-price-bottle').value.trim(), bucket: document.getElementById('stripe-price-bucket').value.trim(), case: document.getElementById('stripe-price-case').value.trim() }; const res = await fetch(WORKER_CONFIG_URL,{ method:'PUT', headers: Object.assign({ 'Content-Type':'application/json', 'Authorization': requireSession()||'' }, et? { 'If-Match': et }: {}), body: JSON.stringify(j,null,2) }); document.getElementById('stripe-msg').textContent = res.ok? 'Saved' : 'Save failed'; }catch(_){ document.getElementById('stripe-msg').textContent='Error' }
}
loadStripe()
document.getElementById('stripe-save').addEventListener('click', function(e){ e.preventDefault(); saveStripe() })
</script>
</body>
</html>
