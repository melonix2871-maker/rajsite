<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read Only Data</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230066ff'/%3E%3Ctext x='16' y='22' font-size='18' text-anchor='middle' fill='white' font-family='Arial'%3EJ%3C/text%3E%3C/svg%3E">
</head>
<body>
<div id="auth-ui" style="margin-bottom:12px">
  <span id="user-echo">Read-only mode</span>
  <button id="sign-in-btn" onclick="window.location.href='login.html'">Admin Login</button>
  <button id="sign-out-btn" style="display:none">Sign out</button>
</div>
<div style="margin-top:6px;font-size:13px">
  <span id="config-status" style="color:#a00"></span>
  <button id="recheck-config" onclick="checkConfigJs()" style="margin-left:8px;padding:4px 8px">Recheck config</button>
</div>
<script src="config.js"></script>
<!-- CoreEngineDB config is provided by config.js -->
<script>
// Diagnostic: check config.js is served and show status
async function checkConfigJs(){
  const el = document.getElementById('config-status');
  if(!el) return;
  try{
    const r = await fetch('config.js', { cache: 'no-store' });
    if(r.ok){ el.textContent = '✅ config.js loaded'; el.style.color = '#070'; }
    else { el.textContent = '❌ config.js not found (HTTP ' + r.status + ')'; el.style.color = '#a00'; }
  }catch(e){ el.textContent = '❌ config.js fetch error'; el.style.color = '#a00'; console.error('checkConfigJs error', e); }
}
checkConfigJs();
</script>
<div id="json-output" style="display:none"></div>
<h1>Data</h1>
<div style="margin:8px 0">
  <label>Name <input id="filter-name" type="text" placeholder="filter name"></label>
  <label style="margin-left:12px">Country <input id="filter-country" type="text" placeholder="filter country"></label>
  <button id="apply-filter">Apply</button>
  <span id="status" style="margin-left:12px"></span>
  </div>
<table id="data-table" class="table-list table table-responsive table-striped" style="width:100%">
  <thead>
    <tr>
      <th class="coll-id">id</th>
      <th class="coll-0">profile</th>
      <th class="coll-1 name">name</th>
      <th class="coll-2">height</th>
      <th class="coll-3">weight</th>
      <th class="coll-date">date</th>
      <th class="coll-4"><span class="info">info</span></th>
      <th class="coll-5">country</th>
    </tr>
  </thead>
  <tbody></tbody>
  </table>
<script>
async function fetchRemoteJson(){
  try{
    if(!window.__CONFIG || !window.__CONFIG.coreengine || !window.__CONFIG.coreengine.dbUrl){ return [] }
    const url = window.__CONFIG.coreengine.dbUrl
    const auth = sessionStorage.getItem('cedb_auth') || ''
    const headers = auth ? { 'Authorization': auth } : {}
    const r = await fetch(url, { headers, cache:'no-store', mode:'cors', credentials:'omit' })
    if(!r.ok){ document.getElementById('status').textContent = '0 rows'; return [] }
    const t = await r.text()
    try{ return JSON.parse(t) }catch(_){ return [] }
  }catch(_e){ return [] }
}
</script>
<script>
// Firebase UI: show signed-in user details and sign-in/out
// Simple banner; admin login is on login.html

async function getJson(){
  const data = await fetchRemoteJson()
  return Array.isArray(data) ? data : []
}
async function renderFromJson(){
  const data = await getJson();
  if(!data) return false;
  const nameQ = document.getElementById('filter-name').value.trim().toLowerCase();
  const countryQ = document.getElementById('filter-country').value.trim().toLowerCase();
  const filtered = data.filter(r =>
    (!nameQ || String(r.name||'').toLowerCase().includes(nameQ)) &&
    (!countryQ || String(r.country||'').toLowerCase().includes(countryQ))
  );
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';
  for(let i=0;i<filtered.length;i++){
    const r = filtered[i];
    const id = r.id || (i+1);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${id}</td><td></td><td>${r.name||''}</td><td>${r.height||''}</td><td>${r.weight||''}</td><td>${r.datecreated||''}</td><td>${r.metavalue||''}</td><td>${r.country||''}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = `${filtered.length} rows`;
  return true;
}
document.getElementById('apply-filter').addEventListener('click', () => { renderFromJson(); });
function updateId1Name(){
  const data = getJson();
  if(!data || !data.length) return false;
  const rec = data.find(r => (r.seq||0) === 1) || data[0];
  const el = document.getElementById('id1-name');
  if(el) el.textContent = rec && rec.name ? rec.name : '';
  return true;
}
function updateDataTargets(){
  const data = getJson();
  if(!data || !data.length) return false;
  const nodes = document.querySelectorAll('[data-id]');
  nodes.forEach(el => {
    const idAttr = el.getAttribute('data-id');
    const idNum = Number(idAttr);
    const rec = data.find(r => (Number(r.seq)||0) === idNum) || data[(idNum>0?idNum-1:0)] || data[0];
    const ds = el.dataset;
    let field = 'name';
    if ('weight' in ds) field = 'weight';
    else if ('name' in ds) field = 'name';
    else if ('height' in ds) field = 'height';
    else if ('date' in ds) field = 'date';
    else if ('info' in ds) field = 'info';
    else if ('country' in ds) field = 'country';
    el.textContent = rec && rec[field] ? rec[field] : '';
  });
  return true;
}
document.getElementById('apply-filter').addEventListener('click', () => { renderFromJson(); updateId1Name(); updateDataTargets(); });
const iv = setInterval(async ()=>{ const a = await renderFromJson(); const b = updateId1Name(); const c = updateDataTargets(); if(a && b && c){ clearInterval(iv); } }, 500);
</script>
<div data-id="1" data-name style="margin-top:8px">display name here</div>
<div data-id="1" data-weight style="margin-top:8px">display weight here</div>
</body>
</html>
