<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read Only Data</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230066ff'/%3E%3Ctext x='16' y='22' font-size='18' text-anchor='middle' fill='white' font-family='Arial'%3EJ%3C/text%3E%3C/svg%3E">
</head>
<body>
<div id="json-output" style="display:none"></div>
<h1>Data</h1>
<div style="margin:8px 0">
  <label>Collection <input id="filter-collection" type="text" placeholder="filter collection"></label>
  <label style="margin-left:12px">Meta Key <input id="filter-metakey" type="text" placeholder="filter metakey"></label>
  <button id="apply-filter">Apply</button>
  <span id="status" style="margin-left:12px"></span>
  </div>
<table id="data-table" class="table-list table table-responsive table-striped" style="width:100%">
  <thead>
    <tr>
      <th class="coll-id">id</th>
      <th class="coll-0">relid</th>
      <th class="coll-1">prefix</th>
      <th class="coll-2">collection</th>
      <th class="coll-3">metakey</th>
      <th class="coll-4">metavalue</th>
      <th class="coll-5">datecreated</th>
      <th class="coll-6">dateupdated</th>
    </tr>
  </thead>
  <tbody></tbody>
  </table>
<script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/php-wasm/php-tags.jsdelivr.mjs"></script>
<script>
// Build script will inject these from .env.local
const GITHUB_TOKEN = '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';
const GIST_ID = '4cf6fd9610bf7df5b82fc036111bfc5d';
const GIST_FILENAME = 'records.json';

async function loadFromGist(){
  try{
    const res = await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':`token ${GITHUB_TOKEN}`}});
    if(!res.ok) return null;
    const gist = await res.json();
    const file = gist.files[GIST_FILENAME];
    if(!file) return null;
    const j = JSON.parse(file.content);
    if(Array.isArray(j)) return j;
  }catch(_e){}
  return null
}
</script>
<script id="db" src="db.html" type="text/html"></script>
<script type="text/php" data-stdin="#db" data-stdout="#json-output">
<?php
error_reporting(E_ERROR | E_PARSE);
libxml_use_internal_errors(true);
$html = file_get_contents('php://stdin');
$dom = new DOMDocument();
$dom->loadHTML($html);
$rows = $dom->getElementsByTagName('tr');
$result = [];
foreach ($rows as $row) {
  $cells = $row->getElementsByTagName('td');
  if ($cells->length === 0) { continue; }
  $id = trim($cells->item(0)->textContent);
  $relid = (int) trim($cells->item(1)->textContent);
  $prefix = trim($cells->item(2)->textContent);
  $collection = trim($cells->item(3)->textContent);
  $metakey = trim($cells->item(4)->textContent);
  $metavalue = trim($cells->item(5)->textContent);
  $datecreated = $cells->length > 6 ? trim($cells->item(6)->textContent) : '';
  $dateupdated = $cells->length > 7 ? trim($cells->item(7)->textContent) : $datecreated;
  $result[] = [
    "id" => $id,
    "relid" => $relid,
    "prefix" => $prefix,
    "collection" => $collection,
    "metakey" => $metakey,
    "metavalue" => $metavalue,
    "datecreated" => $datecreated,
    "dateupdated" => $dateupdated
  ];
}
echo json_encode($result, JSON_PRETTY_PRINT);
?>
</script>
<script>
function getJson(){
  const ls = localStorage.getItem('records');
  if(ls){ try{ return JSON.parse(ls) } catch(_e){ return null } }
  const out = document.getElementById('json-output').textContent || document.getElementById('json-output').innerText;
  if(!out) return null;
  try { return JSON.parse(out); } catch(_e){ return null; }
}
function renderFromJson(){
  const data = getJson();
  if(!data) return false;
  const collectionQ = document.getElementById('filter-collection').value.trim().toLowerCase();
  const metakeyQ = document.getElementById('filter-metakey').value.trim().toLowerCase();
  const filtered = data.filter(r =>
    (!collectionQ || String(r.collection||'').toLowerCase().includes(collectionQ)) &&
    (!metakeyQ || String(r.metakey||'').toLowerCase().includes(metakeyQ))
  );
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';
  for(let i=0;i<filtered.length;i++){
    const r = filtered[i];
    const id = r.id || (i+1);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${id}</td><td>${r.relid||''}</td><td>${r.prefix||''}</td><td>${r.collection||''}</td><td>${r.metakey||''}</td><td>${r.metavalue||''}</td><td>${r.datecreated||''}</td><td>${r.dateupdated||''}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = `${filtered.length} rows`;
  return true;
}
document.getElementById('apply-filter').addEventListener('click', () => { renderFromJson(); });
function updateId1Collection(){
  const data = getJson();
  if(!data || !data.length) return false;
  const rec = data.find(r => (r.seq||0) === 1) || data[0];
  const el = document.getElementById('id1-collection');
  if(el) el.textContent = rec && rec.collection ? rec.collection : '';
  return true;
}
function updateDataTargets(){
  const data = getJson();
  if(!data || !data.length) return false;
  const nodes = document.querySelectorAll('[data-id]');
  nodes.forEach(el => {
    const idAttr = el.getAttribute('data-id');
    const idNum = Number(idAttr);
    const rec = data.find(r => (Number(r.seq)||0) === idNum) || data[(idNum>0?idNum-1:0)] || data[0];
    const ds = el.dataset;
    let field = 'collection';
    if ('metavalue' in ds) field = 'metavalue';
    else if ('metakey' in ds) field = 'metakey';
    else if ('collection' in ds) field = 'collection';
    else if ('prefix' in ds) field = 'prefix';
    else if ('relid' in ds) field = 'relid';
    else if ('datecreated' in ds) field = 'datecreated';
    else if ('dateupdated' in ds) field = 'dateupdated';
    el.textContent = rec && rec[field] !== undefined ? rec[field] : '';
  });
  return true;
}
document.getElementById('apply-filter').addEventListener('click', () => { renderFromJson(); updateId1Collection(); updateDataTargets(); });
const iv = setInterval(async ()=>{ 
  let a = renderFromJson(); 
  let b = updateId1Collection(); 
  let c = updateDataTargets(); 
  if(!a){
    const gistData = await loadFromGist();
    if(gistData && Array.isArray(gistData)){
      localStorage.setItem('records',JSON.stringify(gistData));
      a = renderFromJson();
      b = updateId1Collection();
      c = updateDataTargets();
    }
  }
  if(a && b && c){ clearInterval(iv); } 
}, 100);
</script>
<div data-id="1" data-collection style="margin-top:8px">display collection here</div>
<div data-id="1" data-metavalue style="margin-top:8px">display metavalue here</div>
</body>
</html>
